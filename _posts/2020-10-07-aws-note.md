---
layout: post
title: aws-note
tags: [aws]
---

### VPC

Virtual Private Cloud，能建立一个跨实例分享资源的网络。

为了减少延迟，aws在世界各地有各种Region，一个Region包含很多Availability Zone，Availability Zone是真正包含物理数据中心的地方，为aws provide redundancy。比方说一个Region的有三个Zone 分别为A，B，C，如果遇到什么灾害，A挂了，我们依然能够访问数据，因为数据A中的数据会被同步到B，C。

拿家庭网络来说，首先也是最重要的是你的网络提供商要提供一个你家里到互联网的连接。要使得你的设备能连接到互联网，你需要一个gateway，而modem就是用来当作gateway，modem连接着一个有线或者无线路由，这个路由能使你家中的设备能连接到彼此，并且通过cabel modem访问到互联网。

![image-20201019190903374](C:\Users\Arenas\AppData\Roaming\Typora\typora-user-images\image-20201019190903374.png)

当终端设备，像手机电脑，要访问网络的话，首先要经过的是firewall，firewall设计为提供一个安全层，用来阻止一些不希望的流量（比如病毒），以及允许一些特定的流量通过。比如如果要访问某个网页的页面，就得允许80端口的开放，然后请求才能通过firewall到达路由器，然后到modem然后到互联网。

![image-20201019190953400](C:\Users\Arenas\AppData\Roaming\Typora\typora-user-images\image-20201019190953400.png)

如果放到VPC中来说呢？

![image-20201019191147636](C:\Users\Arenas\AppData\Roaming\Typora\typora-user-images\image-20201019191147636.png)

图中EC2就相当于家中的终端设备，如果EC2要访问某个网页，首先要经过的就是NACL，NACL的行为就类似于firewall，我们需要允许80端口的流量通过NACL，允许后，流量会到达Route Table，他来决定要如果处理该流量，是发到互联网还是本地的其他VPC，如果该流量的目的地是互联网，那就把他发送到 Internet gateway，Internet gateway 可以类比下modem，把流量传输到互联网中。比较家庭网络的例子，可以看到他们基本的处理流程是很相似的。

当创建了一个AWS账户的时候，会同时创建一个默认的VPC，包括一些基本的组件（Internet gateway ，route table，NACL and subnets），来使得你的VPC正常工作。

#### Internet gateway

有的时候缩写为IGW，概念上来讲，IGW类似于家庭网络中的modem。简单定义为：是硬件和软件的组合，用来给你的私有网络提供一个通往外部世界（Internet）的道路。所以如果没有gateway，那么你的VPC是无法连接到互联网的。在你考虑IGW的时候，就想象下modem是如何连通你的ISP的。

一个VPC任意时间只能attach一个IGW。

#### Route Tables

有时候缩写为RTs，定义为包含一套被称作routes的rules，用来决定流量导向何处。

控制台的Route Tables页面上的路由标签下可以看到指定路由的所有的规则，Destination列表示如果收到的流量指向的ip范围是在当前列范围内，则把该流量送到该行的target去，比如local，就是送到本地的其他VPC。如果不是在这个范围内，则去匹配下面下面的路由，有个默认的0.0.0.0/0，表示的就是匹配所有路由，送到外面的网络中去，target是一个IGW，即可以流量交给modem。

当VPC没有attach任何IGW的时候，本质上你的数据还是会被通过路由转发到IGW，但是IGW没有办法将数据发送到外网。就好比你的modem仍然在线，但是连不上你的ISP了。此时你控制台的路由规则标签页会在0.0.0.0/0的那行的status那里显示Black Hole，就表示**当前行**的IGW detached了。值得注意的时候，Destination是和特定IGW挂钩的，VPC如果attach了其他的IGW，但是路由规则里没有配置到这个IGW，那么VPC还是无法访问外网的。

#### Network Access Control List（NACLs）

NACL的行为像是firewall，控制着流量的进出。

在控制台的NACL页面，找到入站规则标签页，创建VPC的时候，会默认创建一个NACL，同时会默认创建入站规则和出站规则，规则列是数字和`*`号，这列表示的是规则的优先级别，数值越小的优先。比如创建一个`规则#`为80的ssh，源为0.0.0.0/0，deny的规则，此时ssh就连不上了。再同样创建一个优先级为70，但是allow的规则，就可以连上了。因为优先匹配70这条规则。

#### Subnets

是网络的一个subsection，通常来说，一个subnet包括一个特定区域内的所有计算机。想象之前ISP的类比，ISP是一个网络，而你的家庭网络就可以看作是一个subnet，不过这个比喻没有那么好。

subnet有public和private两种，通常来说public subnet里面一般放ec2，private subnet里放RDS，public有连通到外网的route，但是private只能和其他subnet通信。所以，事实上的private subnet也就是route table里没有配置去往外网的路由，即没有给他配IGW，没有IGW，当然就去不了外网。通过这种方式使他只能和本地的其他subnet交流。

#### Availability Zones

之前也提到，aws的全球基础设施，有多个Region，Region下有多个Availability Zone，每个Zone下有物理意义上的数据中心。当你创建一个VPC的时候，会自动在多个Availability Zone下创建subnet，这样就可以把数据放在多个zone下，使得即使一个zone挂了，其他的可以继续提供服务

### EC2

概念上来说，ec2就是一台在aws上计算机。对比一下通常意义上的计算机的话，cpu对应实例类型（instance type），硬盘对应EBS，网卡对应IP Addressing，这是一个虚拟的网络适配器，他能使我们访问VPC中的网络，防火墙对应安全组，内存对应RAM。

#### Amazon Machine Images (AMIs)

AMIs是预先配置好了一些用于启动一个ec2实例的包，包括操作系统，一些软件包，以及一些设置。嗯，镜像嘛。

AMI分为社区AMI，AWS Marketplace，自己的AMI。

社区AMI就是基本没有附带其他软件的，你可以自己手动安装你要的。

AWS Marketplace是镜像市场，有一些厂家卖他们做的AMI。

#### Elastic Block Store（EBS）

ec2的一种存储卷，高度可用，可靠的存储卷。在同一个Zone下，可以被attach到任何正在运行的实例上。

IOPS：input/output Operations per Second。EBS的一个性能指标。

每个ec2实例都会有一个根存储卷，这个卷可能是EBS，也可能不是。创建实例选择卷的时候，有个Delete on Termination的选项，勾上就表示，如果以后把这个ec2干掉了，那么这个卷也会同时被干掉，不勾就会保留下来，处于一个没有被attach到任何实例上的状态。

根卷之外新建的卷可以很方便的从这个ec2上detach掉，然后attach到另一台ec2上。

#### Security Group

安全组很像之前VPC中的NACLs，用来控制进出流量，只是安全组是实例层级的，而不是subnet层级的。aws把安全组定义为虚拟防火墙。

NACLs有deny的选项，安全组没有，没有配置流量会默认deny掉。NACL有那个优先级的数字，而安全组没有。

![image-20201021212552713](C:\Users\Arenas\AppData\Roaming\Typora\typora-user-images\image-20201021212552713.png)

ELB负责负载均衡，控制进来的流量要交给哪个实例，如果两个实例的安全组配置不一样，比如一个允许80端口，一个不允许，那么当ELB将该流量分配给那个不允许的端口的时候，就会返回一个错误。所以NACL和安全的规则配置是很重要的。

另一个和NACL不同的是，安全组是stateful的。意思就是，任何被允许的流量进来后，即时没有匹配任何出站规则，也是默认可以让他出去的。而NACL是stateless的，如果没有匹配一个出站规则，那么该流量就会被deny掉。

#### IP Addressing

简单来说，它负责为你的ec2提供一个public IP address，使其能够和互联网进行交流，如果没有这个ip地址，那么ec2是不能和VPC外面的世界交流的。简单来说，ip地址就是网络上一个实例的地址。

默认每个实例会有public和private IP地址，私有地址让你的ec2可以和其他实例交流，只要他们在同一个VPC，或者broader private network。

![image-20201021214703500](C:\Users\Arenas\AppData\Roaming\Typora\typora-user-images\image-20201021214703500.png)

如果你的实例连不上网了，那么上图这些实例的配置都需要好好检查。

